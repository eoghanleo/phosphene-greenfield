#!/usr/bin/env bash
#
# VIRRIC CLI (drop-in)
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(cd "$SCRIPT_DIR/../lib" 2>/dev/null && pwd || true)"
if [[ -z "${LIB_DIR:-}" || ! -f "$LIB_DIR/virric_env.sh" ]]; then
  # Repo layout fallback: virric/virric-core/bin/virric -> virric/virric-core/lib/virric_env.sh
  LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"
fi
# shellcheck source=/dev/null
source "$LIB_DIR/virric_env.sh"

CMD="${1:-help}"
shift || true

if [[ -t 1 ]]; then
  # Core Virric colors
  VIRRIC_GREEN='\033[38;5;118m'      # The signature "weird green"
  VIRRIC_BRIGHT='\033[38;5;154m'     # Brighter variant
  VIRRIC_NEON='\033[38;5;46m'        # Neon eye-searing green
  VIRRIC_DARK='\033[38;5;28m'        # Darker subdued variant

  # Cyberpunk accent colors
  CYAN_GLOW='\033[38;5;51m'          # Bright cyan
  MAGENTA_PULSE='\033[38;5;201m'     # Hot magenta
  BLUE_ELECTRIC='\033[38;5;33m'      # Electric blue
  YELLOW_HAZARD='\033[38;5;226m'     # Warning yellow

  # Text effects
  BOLD='\033[1m'
  DIM='\033[2m'
  REVERSE='\033[7m'
  RESET='\033[0m'

  # Background options
  BG_BLACK='\033[40m'
else
  VIRRIC_GREEN='' VIRRIC_BRIGHT='' VIRRIC_NEON='' VIRRIC_DARK=''
  CYAN_GLOW='' MAGENTA_PULSE='' BLUE_ELECTRIC='' YELLOW_HAZARD=''
  BOLD='' DIM='' REVERSE='' RESET='' BG_BLACK=''
fi

print_hr() {
  echo -e "${VIRRIC_DARK}╾───────⟨${VIRRIC_GREEN} $1 ${VIRRIC_DARK}⟩───────╼${RESET}"
}

banner() {
  echo -e "${BG_BLACK}"
  echo -e "${VIRRIC_BRIGHT}╔═══════════════════════════════════════════════════════════════════════════╗${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${VIRRIC_NEON}${BOLD}██╗   ██╗██╗██████╗ ██████╗ ██╗ ██████╗${RESET}               ${CYAN_GLOW}╱╱╱╱╱╱╱╭╮╱╱╱╱╱╱╱╱╱╱${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${VIRRIC_NEON}${BOLD}██║   ██║██║██╔══██╗██╔══██╗██║██╔════╝${RESET}               ${CYAN_GLOW}╱╱╱╱╱╭╮┃┃╱╱╱╱╱╱╱╱╱╱${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${VIRRIC_NEON}${BOLD}██║   ██║██║██████╔╝██████╔╝██║██║     ${RESET}               ${CYAN_GLOW}╱╱╱╱╱┃┃┃┃╭╮╱╱╱╱╱╱╱╱${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${VIRRIC_GREEN}${BOLD}╚██╗ ██╔╝██║██╔══██╗██╔══██╗██║██║     ${RESET}               ${CYAN_GLOW}╱╱╱╭╮┃┃┃┃┃┃╭╮╱╱╭╮╱╱${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${VIRRIC_GREEN}${BOLD} ╚████╔╝ ██║██║  ██║██║  ██║██║╚██████╗${RESET}               ${CYAN_GLOW}───┫┃┃┃┃┃┃┃┃┃╭╮┃┣──${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${VIRRIC_GREEN}${BOLD}  ╚═══╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝ ╚═════╝${RESET}               ${CYAN_GLOW}╱╱╱╰╯┃┃┃┃╰╯┃┃╰╯╰╯╱╱${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET}                                                       ${CYAN_GLOW}╱╱╱╱╱╰╯┃┃╱╱╰╯╱╱╱╱╱╱${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${VIRRIC_BRIGHT}[ SDLC NEUROFRAMEWORK ]${RESET} ${VIRRIC_DARK}<< V.0.2.0 >>                 ${CYAN_GLOW}╱╱╱╱╱╱╱┃┃╱╱╱╱╱╱╱╱╱╱${RESET} ${VIRRIC_BRIGHT}║${RESET}"
  echo -e "${VIRRIC_BRIGHT}║${RESET} ${MAGENTA_PULSE}BASH-FIRST SDLC TOOLBOX (DROP-IN)${RESET}                         ${CYAN_GLOW}╱╱╱╱╱╱╱╰╯╱╱╱╱╱╱╱╱╱╱${RESET}${VIRRIC_BRIGHT} ║${RESET}"
  echo -e "${VIRRIC_BRIGHT}╚═══════════════════════════════════════════════════════════════════════════╝${RESET}"
  echo ""
  echo -e "${REVERSE}${VIRRIC_NEON} V_I_R_R_I_C NEUROFRAMEWORK ACTIVATED ${RESET}"
  echo ""
}

doctor() {
  banner
  print_hr "SYSTEM DIAGNOSTICS"
  echo -e "${VIRRIC_GREEN}[${CYAN_GLOW}SYS${VIRRIC_GREEN}]${RESET} ${DIM}Scanning dependency matrix...${RESET}"
  local missing=0

  for c in bash awk sed grep find date; do
    if command -v "$c" &> /dev/null; then
      echo -e "${VIRRIC_GREEN}[${VIRRIC_BRIGHT}OK${VIRRIC_GREEN}]${RESET} $c"
    else
      echo -e "${VIRRIC_GREEN}[${YELLOW_HAZARD}ERROR${VIRRIC_GREEN}]${RESET} $c not found"
      missing=1
    fi
  done

  if command -v tree &> /dev/null; then
    echo -e "${VIRRIC_GREEN}[${VIRRIC_BRIGHT}OK${VIRRIC_GREEN}]${RESET} tree: $(tree --version 2>/dev/null | head -n 1 || echo installed)"
  else
    echo -e "${VIRRIC_GREEN}[${BLUE_ELECTRIC}INFO${VIRRIC_GREEN}]${RESET} tree not found (optional)"
  fi

  echo ""
  if [[ "$missing" -eq 0 ]]; then
    echo -e "${VIRRIC_GREEN}[${VIRRIC_BRIGHT}OK${VIRRIC_GREEN}]${RESET} ${VIRRIC_NEON}All required tools detected.${RESET}"
    return 0
  fi
  echo -e "${VIRRIC_GREEN}[${YELLOW_HAZARD}WARN${VIRRIC_GREEN}]${RESET} Missing required tools."
  return 1
}

help() {
  cat <<EOF
VIRRIC (drop-in)

Usage:
  ./virric/virric-core/bin/virric <command>

Commands:
  banner   Print the VIRRIC neon banner
  doctor   Print banner + dependency diagnostics
  id       Global ID registry (build/validate/where/next)
  help     Show this help

ID registry:
  ./virric/virric-core/bin/virric id build
  ./virric/virric-core/bin/virric id validate
  ./virric/virric-core/bin/virric id where <ID>
  ./virric/virric-core/bin/virric id next --type <type>

EOF
}

id_help() {
  cat <<'EOF'
VIRRIC ID REGISTRY (global)

Usage:
  ./virric/virric-core/bin/virric id [build|validate|where <ID>|next --type <type>]

Notes:
  - This is a repo-wide registry (writes to: virric/id_index.tsv)
  - Implementation lives in:
      virric/virric-core/bin/id_registry.sh

EOF
}

id_cmd() {
  local root
  root="$(virric_find_project_root)" || {
    echo "VIRRIC: not in a VIRRIC project (cannot find repo root with ./virric)." 1>&2
    return 1
  }

  local impl="$root/virric/virric-core/bin/id_registry.sh"
  if [[ ! -f "$impl" ]]; then
    echo "VIRRIC: missing ID registry implementation: $impl" 1>&2
    return 1
  fi

  local sub="${1:-build}"
  case "$sub" in
    -h|--help|help) id_help; return 0 ;;
  esac

  bash "$impl" "$sub" "${@:2}"
}

case "$CMD" in
  banner) banner ;;
  doctor) doctor ;;
  id) id_cmd "$@" ;;
  help|-h|--help) help ;;
  *)
    echo "Unknown command: $CMD" 1>&2
    help
    exit 1
    ;;
esac


