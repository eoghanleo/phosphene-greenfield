name: "PHOSPHENE / Consume research signal (on handoff issue close)"

on:
  issues:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: read

concurrency:
  group: phosphene-consume-signal-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  consume:
    if: contains(github.event.issue.labels.*.name, 'phosphene:handoff')
    runs-on: ubuntu-latest
    steps:
      - name: Extract upstream research signal path from issue body
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const match = body.match(/`(phosphene\/domains\/research\/signals\/[^`]+\.json)`/);
            if (!match) {
              core.notice("PHOSPHENE: no research signal path found in issue body; nothing to consume.");
              return;
            }
            core.setOutput("signal_path", match[1]);

      - name: Checkout main
        if: steps.extract.outputs.signal_path != ''
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 1

      - name: Move signal into _consumed/ and open PR
        if: steps.extract.outputs.signal_path != ''
        env:
          SIGNAL_PATH: ${{ steps.extract.outputs.signal_path }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          set -euo pipefail

          sig="$SIGNAL_PATH"
          if [[ "$sig" == *"/signals/_consumed/"* ]]; then
            echo "Already consumed: $sig"
            exit 0
          fi

          if [[ ! -f "$sig" ]]; then
            echo "Signal not found on main (already moved/removed?): $sig"
            exit 0
          fi

          dest_dir="phosphene/domains/research/signals/_consumed/issue-${ISSUE_NUMBER}"
          mkdir -p "$dest_dir"

          branch="phosphene/consume-signal/issue-${ISSUE_NUMBER}"
          git config user.name "phosphene-bot"
          git config user.email "phosphene-bot@users.noreply.github.com"
          git checkout -b "$branch"

          git mv "$sig" "$dest_dir/"

          git commit -m "PHOSPHENE: consume research signal (issue #${ISSUE_NUMBER} closed)" \
            -m "Upstream: ${ISSUE_URL}" \
            -m "Moved: ${sig} -> ${dest_dir}/"

          git push --set-upstream origin "$branch"

      - name: Create PR to merge consumption change
        if: steps.extract.outputs.signal_path != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;
            const branch = `phosphene/consume-signal/issue-${issue.number}`;

            const title = `PHOSPHENE: consume research signal (issue #${issue.number})`;
            const body = [
              `Automated signal consumption for closed handoff issue #${issue.number}.`,
              ``,
              `This PR moves the upstream research signal into \`phosphene/domains/research/signals/_consumed/\` so it cannot be re-consumed.`,
              ``,
              `- Issue: ${issue.html_url}`,
            ].join("\n");

            // If a PR already exists for this branch, don't create another.
            const existing = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:${branch}`,
              state: "open",
              per_page: 5,
            });
            if (existing.data.length > 0) {
              core.notice(`PHOSPHENE: consumption PR already open: ${existing.data[0].html_url}`);
              return;
            }

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              head: branch,
              base: "main",
              title,
              body,
            });

            core.notice(`PHOSPHENE: opened consumption PR: ${pr.data.html_url}`);

