name: "instrument.gantry.prism.global.from_flimsie"

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

concurrency:
  group: instrument-prism-from-flimsie-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  parse:
    runs-on: ubuntu-latest
    outputs:
      lane: ${{ steps.parse.outputs.lane }}
      intent: ${{ steps.parse.outputs.intent }}
      issue_number: ${{ steps.parse.outputs.issue_number }}
      ok: ${{ steps.parse.outputs.ok }}
    steps:
      - name: Parse /phosphene command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const bodyRawFull = (context.payload.comment?.body || "");
            const firstLine = bodyRawFull.split(/\r?\n/, 1)[0].trim();
            const issue_number = context.payload.issue.number;

            // Only respond to explicit summons to avoid loops/noise.
            if (!firstLine.startsWith("/phosphene ")) {
              core.setOutput("ok", "0");
              return;
            }

            // Format:
            //   /phosphene beryl <intent...>
            //   /phosphene cerulean <intent...>
            const match = firstLine.match(/^\/phosphene\s+(beryl|cerulean)\s*(.*)$/i);
            if (!match) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: "PHOSPHENE: Unknown summon. Use `/phosphene beryl <intent>` or `/phosphene cerulean <intent>`.",
              });
              core.setOutput("ok", "0");
              return;
            }

            const lane = match[1].toLowerCase();
            const intent = (match[2] || "").trim() || "(no intent provided)";

            core.setOutput("ok", "1");
            core.setOutput("lane", lane);
            core.setOutput("intent", intent);
            core.setOutput("issue_number", String(issue_number));

  beryl:
    if: needs.parse.outputs.ok == '1' && needs.parse.outputs.lane == 'beryl'
    needs: [parse]
    uses: ./.github/workflows/instrument.apparatus.collector.research.deep_research.yml
    secrets: inherit
    with:
      issue_number: ${{ fromJson(needs.parse.outputs.issue_number) }}
      intent: ${{ needs.parse.outputs.intent }}

  cerulean:
    if: needs.parse.outputs.ok == '1' && needs.parse.outputs.lane == 'cerulean'
    needs: [parse]
    uses: ./.github/workflows/instrument.apparatus.modulator.product-marketing.summon.yml
    secrets: inherit
    with:
      issue_number: ${{ fromJson(needs.parse.outputs.issue_number) }}
      intent: ${{ needs.parse.outputs.intent }}

