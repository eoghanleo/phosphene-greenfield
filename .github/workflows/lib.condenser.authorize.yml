name: "lib.condenser.authorize"

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      label:
        required: false
        type: string
        default: "phosphene:coupling:authorized"
      message:
        required: false
        type: string
        default: ""

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  authorize:
    runs-on: ubuntu-latest
    steps:
      - name: Authorize coupling (label + comment)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ inputs.pr_number }}");
            const labelName = ("${{ inputs.label }}" || "").trim();
            const message = ("${{ inputs.message }}" || "").trim();

            // Ensure label exists (best-effort).
            if (labelName) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName });
              } catch (e) {
                if (e.status !== 404) throw e;
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: "16A34A", // green
                  description: "PHOSPHENE: coupling authorized by gantry condenser",
                });
              }

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr_number,
                labels: [labelName],
              });
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: [
                "PHOSPHENE: condenser authorization",
                "",
                `- **Label**: ${labelName ? "`" + labelName + "`" : "(none)"}`,
                message ? `- **Message**: ${message}` : "- **Message**: (none)",
              ].join("\n"),
            });

