name: "instrument.gantry.detector.global.runtime_predicates"

on:
  workflow_dispatch:
    inputs:
      title:
        description: "Title for the detector run"
        required: false
        type: string
        default: "Runtime detector predicates"
      command:
        description: "Deterministic predicate command to run (bash)"
        required: true
        type: string
      pr_number:
        description: "Optional PR number to annotate / drive follow-on actions"
        required: false
        type: number
      on_success_authorize:
        description: "If true (and pr_number set), call condenser.couple_when_green"
        required: false
        type: boolean
        default: false
      on_failure_rework_lane:
        description: "If set (and pr_number set), post a /phosphene summon comment to trigger rework"
        required: false
        type: choice
        options:
          - ""
          - beryl
          - cerulean
        default: ""
      on_failure_rework_intent:
        description: "Intent string passed to /phosphene <lane> <intent>"
        required: false
        type: string
        default: "rework: detector predicates failed"

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  predicates:
    uses: ./.github/workflows/lib.detector.run_script.yml
    with:
      title: ${{ inputs.title }}
      command: ${{ inputs.command }}

  on_success_authorize:
    if: needs.predicates.result == 'success' && inputs.on_success_authorize && inputs.pr_number
    needs: [predicates]
    uses: ./.github/workflows/instrument.gantry.condenser.global.couple_when_green.yml
    with:
      pr_number: ${{ inputs.pr_number }}
      message: "Detector runtime predicates are green."

  on_failure_rework:
    if: needs.predicates.result != 'success' && inputs.on_failure_rework_lane != '' && inputs.pr_number
    needs: [predicates]
    runs-on: ubuntu-latest
    steps:
      - name: Post PHOSPHENE rework summon (multiline; first line is the command)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ inputs.pr_number }}");
            const lane = ("${{ inputs.on_failure_rework_lane }}" || "").trim();
            const intent = ("${{ inputs.on_failure_rework_intent }}" || "").trim() || "rework: detector predicates failed";
            const cmd = `\/phosphene ${lane} ${intent}`.trim();

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: [
                cmd,
                "",
                "PHOSPHENE: this summon was emitted by a DETECTOR after predicate failure.",
                "",
                `- **Detector**: \`${context.workflow}\``,
                `- **Run**: \`${context.runId}\``,
                `- **Predicate command**: \`${{ inputs.command }}\``,
              ].join("\n"),
            });

