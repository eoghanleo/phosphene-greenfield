name: "gantry.detector.global"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: "Which detector action to run"
        required: true
        type: choice
        options: ["runtime_predicates", "file_authorization", "beam_safety", "apparatus_log_attach"]
        default: "runtime_predicates"
      title:
        description: "Title for the runtime detector run (runtime_predicates only)"
        required: false
        type: string
        default: "Runtime detector predicates"
      command:
        description: "Deterministic predicate command to run (bash) (runtime_predicates only)"
        required: false
        type: string
        default: ""
      pr_number:
        description: "Optional PR number to annotate / drive follow-on actions (runtime_predicates only)"
        required: false
        type: number
      on_success_authorize:
        description: "If true (and pr_number set), post condenser authorization note"
        required: false
        type: boolean
        default: false
      on_failure_rework_lane:
        description: "If set (and pr_number set), post a /phosphene summon comment to trigger rework"
        required: false
        type: choice
        options:
          - ""
          - beryl
          - cerulean
        default: ""
      on_failure_rework_intent:
        description: "Intent string passed to /phosphene <lane> <intent>"
        required: false
        type: string
        default: "rework: detector predicates failed"

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  # Gantry write boundary (when/if enabled): signal bus only.
  PHOSPHENE_GANTRY_WRITE_ALLOWLIST: |
    phosphene/signals/**
    phosphene/signals/indexes/**

jobs:
  signals_integrity:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Validate signal JSON (parse + required fields)
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t files < <(find phosphene/signals -type f -name "*.json" -print | sort)
          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No signal JSON files found under phosphene/signals/*.json"
            exit 0
          fi

          echo "Validating ${#files[@]} signal JSON files..."
          fail=0
          for f in "${files[@]}"; do
            node -e '
              const fs = require("fs");
              const f = process.argv[1];
              const raw = fs.readFileSync(f, "utf8");
              const j = JSON.parse(raw);

              if (typeof j !== "object" || j === null || Array.isArray(j)) {
                console.error(`FAIL: signal must be a JSON object: ${f}`);
                process.exit(1);
              }

              if (!("signal_version" in j)) {
                console.error(`FAIL: missing required field signal_version: ${f}`);
                process.exit(1);
              }
              if (j.signal_version !== 1) {
                console.error(`FAIL: signal_version must be 1 (got ${j.signal_version}): ${f}`);
                process.exit(1);
              }

              if (!("signal_type" in j)) {
                console.error(`FAIL: missing required field signal_type: ${f}`);
                process.exit(1);
              }
              if (typeof j.signal_type !== "string" || j.signal_type.trim() === "") {
                console.error(`FAIL: signal_type must be a non-empty string: ${f}`);
                process.exit(1);
              }

              if (!("tamper_hash" in j)) {
                console.error(`FAIL: missing required field tamper_hash: ${f}`);
                process.exit(1);
              }
              if (typeof j.tamper_hash !== "string" || !/^sha256:[0-9a-f]{64}$/i.test(j.tamper_hash)) {
                console.error(`FAIL: tamper_hash must be "sha256:<64-hex>": ${f}`);
                process.exit(1);
              }
            ' "$f" || fail=1
          done
          [[ "$fail" -eq 0 ]]

      - name: Validate signal tamper hash (self-hash)
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t files < <(find phosphene/signals -type f -name "*.json" -print | sort)
          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No signal JSON files found under phosphene/signals/*.json"
            exit 0
          fi

          fail=0
          for f in "${files[@]}"; do
            bash phosphene/phosphene-core/bin/signal_tamper_hash.sh validate "$f" || fail=1
          done
          [[ "$fail" -eq 0 ]]

      - name: Summary
        if: always()
        run: |
          {
            echo "### Signals integrity"
            echo ""
            echo "- **Result**: ${{ job.status }}"
            echo "- **Scope**: \`phosphene/signals/*.json\`"
          } >> "$GITHUB_STEP_SUMMARY"

  tests:
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    name: "Deterministic tests"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run
        shell: bash
        run: "bash ./tests/run.sh"

      - name: Summary
        if: always()
        run: |
          {
            echo "### Detector summary"
            echo ""
            echo "- **Command**: \`bash ./tests/run.sh\`"
            echo "- **Result**: ${{ job.status }}"
          } >> "$GITHUB_STEP_SUMMARY"

  predicates:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'runtime_predicates'
    name: ${{ inputs.title }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Validate inputs (runtime_predicates)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ inputs.command }}" ]]; then
            echo "Missing required input: command (for action=runtime_predicates)" >&2
            exit 2
          fi

      - name: Run predicate command
        shell: bash
        run: ${{ inputs.command }}

  on_success_authorize:
    if: needs.predicates.result == 'success' && inputs.on_success_authorize && inputs.pr_number
    needs: [predicates]
    runs-on: ubuntu-latest
    steps:
      - name: Post condenser authorization note (comment only)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ inputs.pr_number }}");
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: [
                "PHOSPHENE: condenser authorization",
                "",
                "- **Message**: Detector runtime predicates are green.",
              ].join("\\n"),
            });

  on_failure_rework:
    if: needs.predicates.result != 'success' && inputs.on_failure_rework_lane != '' && inputs.pr_number
    needs: [predicates]
    runs-on: ubuntu-latest
    steps:
      - name: Post PHOSPHENE rework summon (multiline; first line is the command)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ inputs.pr_number }}");
            const lane = ("${{ inputs.on_failure_rework_lane }}" || "").trim();
            const intent = ("${{ inputs.on_failure_rework_intent }}" || "").trim() || "rework: detector predicates failed";
            const cmd = `\/phosphene ${lane} ${intent}`.trim();

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: [
                cmd,
                "",
                "PHOSPHENE: this summon was emitted by a DETECTOR after predicate failure.",
                "",
                `- **Detector**: \`${context.workflow}\``,
                `- **Run**: \`${context.runId}\``,
                `- **Predicate command**: \`${{ inputs.command }}\``,
              ].join("\n"),
            });

  file_authorization:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'file_authorization'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "TODO: implement Planning authorized file list signal + diff scan + TRAP ruling."

  beam_safety:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'beam_safety'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "TODO: define the beam safety corridor (schema lint, policy checks, budget checks)."

  apparatus_log_attach:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'apparatus_log_attach'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "TODO: attach apparatus log artifact to PR as summary/comment."

