name: "gantry.trap.product-management"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "phosphene/signals/bus.jsonl"
  push:
    paths:
      - "phosphene/signals/bus.jsonl"
  workflow_dispatch: {}

permissions:
  issues: write
  contents: read

concurrency:
  group: instrument-trap-product-management-${{ github.event.pull_request.number || github.sha || github.run_id }}
  cancel-in-progress: true

jobs:
  comment_remediation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract new bus lines (push)
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          before="${{ github.event.before }}"
          after="${{ github.sha }}"
          git diff --unified=0 "$before" "$after" -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/new_lines.txt || true

      - name: Extract new bus lines (PR)
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          base="${{ github.event.pull_request.base.ref }}"
          git fetch origin "$base:refs/remotes/origin/$base" --force
          git diff --unified=0 "origin/$base"...HEAD -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/new_lines.txt || true

      - name: Post remediation comment(s) for product-management trap signals
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const { owner, repo } = context.repo;

            const raw = fs.existsSync("/tmp/new_lines.txt") ? fs.readFileSync("/tmp/new_lines.txt","utf8") : "";
            const lines = raw.split(/\n/).map(l => l.trim()).filter(Boolean);

            const traps = [];
            for (const line of lines) {
              try {
                const j = JSON.parse(line);
                if (j.signal_type === "phosphene.detector.product-management.trap.v1") traps.push(j);
              } catch {}
            }

            if (traps.length === 0) {
              core.notice("PHOSPHENE: no product-management trap signals found in new lines.");
              return;
            }

            const hasMarker = async (issue_number, marker) => {
              const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
              return (comments.data || []).some((c) => String(c?.body || "").includes(marker));
            };

            for (const t of traps) {
              const issue_number = Number(t.issue_number || 0);
              const work_id = String(t.work_id || "").trim();
              const reason = String(t.reason || "verification_failed").trim();
              const trap_signal_id = String(t.signal_id || "").trim();
              if (!issue_number || !trap_signal_id) continue;

              const marker = `PHOSPHENE-TRAP:signal_id:${trap_signal_id}`;
              if (await hasMarker(issue_number, marker)) {
                core.notice(`PHOSPHENE: trap comment already posted for issue #${issue_number} (${marker})`);
                continue;
              }

              const requiredActions = [
                "- Validate ID registry: `./phosphene/phosphene-core/bin/phosphene id validate`",
                "- Validate bundle: `bash .github/scripts/validate_prd_bundle.sh --strict <bundle_dir>`",
                "- Run done-score: `bash .github/scripts/product-management-domain-done-score.sh <bundle_dir> --min-score 80`",
                `- Re-emit DONE receipt: \`./.codex/skills/phosphene/cerulean/product-management/modulator/scripts/product-management_emit_done_receipt.sh --issue-number ${issue_number} --work-id ${work_id}\``,
              ];

              if (reason === "checks_failed") {
                requiredActions.unshift("- Fix failing CI checks on the PR and re-run until green.");
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "@codex take issue.",
                  "",
                  "PHOSPHENE TRAP: remediation required.",
                  "",
                  "## Context",
                  `- domain: product-management`,
                  `- work_id: \`${work_id}\``,
                  `- issue_number: #${issue_number}`,
                  `- reason: \`${reason}\``,
                  `- trap_signal_id: \`${trap_signal_id}\``,
                  "",
                  "## Required actions (MUST)",
                  ...requiredActions,
                  "",
                  "## Completion",
                  "- Emit a NEW DONE receipt signal after fixes.",
                  "",
                  marker,
                ].join("\n"),
              });
            }

