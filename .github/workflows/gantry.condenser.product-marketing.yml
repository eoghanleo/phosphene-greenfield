name: "gantry.condenser.product-marketing"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to merge"
        required: true
        type: number
      work_id:
        description: "Work ID (optional, for signal emission)"
        required: false
        type: string
      parent_signal_id:
        description: "DONE receipt signal_id (optional; used as parent for merge-complete)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  # Gantry write boundary: signal bus only.
  PHOSPHENE_GANTRY_WRITE_ALLOWLIST: |
    phosphene/signals/**
    phosphene/signals/indexes/**
  PHOSPHENE_HUMAN_TOKEN: ${{ secrets.PHOSPHENE_HUMAN_TOKEN }}

concurrency:
  group: instrument-condenser-product-marketing-${{ inputs.pr_number }}
  cancel-in-progress: false

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Load PR metadata
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number(core.getInput("pr_number", { required: true }));
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
            core.setOutput("head_sha", String(pr.data.head.sha));
            core.setOutput("base_ref", String(pr.data.base.ref));
            core.setOutput("is_merged", pr.data.merged ? "1" : "0");

      - name: Checkout PR head
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0

      - name: Validate bus + domain (POC)
        shell: bash
        run: |
          set -euo pipefail
          bash phosphene/phosphene-core/bin/signal_bus.sh validate --bus phosphene/signals/bus.jsonl
          ./phosphene/phosphene-core/bin/phosphene id validate
          bash phosphene/domains/product-marketing/scripts/product-marketing-domain-done-score.sh --min-score 0

      - name: Merge PR (API)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number(core.getInput("pr_number", { required: true }));
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: pr_number,
              merge_method: "merge",
            });

      - name: Checkout main
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Append merge-complete signal to bus
        shell: bash
        run: |
          set -euo pipefail

          pr_number="${{ inputs.pr_number }}"
          work_id="${{ inputs.work_id }}"
          parent_signal_id="${{ inputs.parent_signal_id }}"

          if [[ -z "${work_id:-}" ]]; then
            work_id="UNKNOWN"
          fi

          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          output_key="condenser:merge-complete:product-marketing:pr:${pr_number}"

          sig_args=(signal-id --run-marker "$work_id" --output-key "$output_key")
          if [[ -n "${parent_signal_id:-}" ]]; then
            sig_args+=(--parent "$parent_signal_id")
          fi
          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh "${sig_args[@]}")"

          if [[ -n "${parent_signal_id:-}" ]]; then
            parents_json="[\"${parent_signal_id}\"]"
          else
            parents_json="[]"
          fi

          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.merge_complete.product-marketing.v1\",\"work_id\":\"${work_id}\",\"domain\":\"product-marketing\",\"pr_number\":${pr_number},\"parents\":${parents_json},\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus phosphene/signals/bus.jsonl --line "$line"

      - name: Commit + push bus append
        shell: bash
        run: |
          set -euo pipefail

          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          fi
          git add "phosphene/signals/bus.jsonl"
          git commit -m "PHOSPHENE: product-marketing merge complete for PR #${{ inputs.pr_number }}"
          git push origin HEAD:main

