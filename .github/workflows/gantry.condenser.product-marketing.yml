name: "gantry.condenser.product-marketing"

on:
  check_suite:
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to approve"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: instrument-condenser-product-marketing-${{ inputs.pr_number || github.event.check_suite.pull_requests[0].number || github.run_id }}
  cancel-in-progress: true

jobs:
  approve_on_check_suite:
    if: github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Resolve PR from check_suite payload
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const prs = Array.isArray(context.payload.check_suite?.pull_requests) ? context.payload.check_suite.pull_requests : [];
            const pr_number = Number(prs?.[0]?.number || 0);
            if (!pr_number) {
              core.notice("PHOSPHENE: check_suite has no PR context; skip.");
              core.setOutput("has_pr", "0");
              return;
            }
            core.setOutput("has_pr", "1");
            core.setOutput("pr_number", String(pr_number));

      - name: Load PR metadata
        id: pr
        if: steps.ctx.outputs.has_pr == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.ctx.outputs.pr_number }}");
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
            const state = String(pr.data.mergeable_state || "").toLowerCase();
            core.setOutput("mergeable_state", state);
            core.setOutput("base_ref", String(pr.data.base.ref));
            core.setOutput("head_sha", String(pr.data.head.sha));
            core.setOutput("is_draft", pr.data.draft ? "1" : "0");
            core.setOutput("is_open", String(pr.data.state || "").toLowerCase() === "open" ? "1" : "0");

      - name: Checkout PR head (by SHA)
        if: steps.ctx.outputs.has_pr == '1' && steps.pr.outputs.is_open == '1'
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0
          persist-credentials: true

      - name: Extract approve signal (product-marketing) from PR diff
        id: approve
        if: steps.ctx.outputs.has_pr == '1' && steps.pr.outputs.is_open == '1'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          base="${{ steps.pr.outputs.base_ref }}"
          git fetch origin "$base:refs/remotes/origin/$base" --force
          git diff --unified=0 "origin/$base"...HEAD -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/pr_new_lines.txt || true

          approve_line="$(node -e '
            const fs=require("fs");
            const raw=fs.existsSync("/tmp/pr_new_lines.txt")?fs.readFileSync("/tmp/pr_new_lines.txt","utf8"):"";
            const lines=raw.split(/\n/).map(l=>l.trim()).filter(Boolean);
            for (const line of lines) {
              try {
                const j=JSON.parse(line);
                if (j.signal_type==="phosphene.detector.product-marketing.approve.v1") {
                  process.stdout.write(line);
                  process.exit(0);
                }
              } catch {}
            }
            process.exit(1);
          ' && true || true)"

          if [[ -z "${approve_line:-}" ]]; then
            echo "has_approve=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          work_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.work_id||""));' "$approve_line")"
          issue_number="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.issue_number||""));' "$approve_line")"
          approve_signal_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.signal_id||""));' "$approve_line")"

          echo "has_approve=1" >> "$GITHUB_OUTPUT"
          echo "work_id=$work_id" >> "$GITHUB_OUTPUT"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "approve_signal_id=$approve_signal_id" >> "$GITHUB_OUTPUT"

      - name: Check for existing condenser approval
        id: review
        if: steps.ctx.outputs.has_pr == '1' && steps.approve.outputs.has_approve == '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.ctx.outputs.pr_number }}");
            const reviews = await github.rest.pulls.listReviews({ owner, repo, pull_number: pr_number, per_page: 100 });
            const already = (reviews.data || []).some(r => r.user?.login === "github-actions[bot]" && r.state === "APPROVED");
            core.setOutput("already_approved", already ? "1" : "0");

      - name: Approve PR (condenser)
        if: steps.ctx.outputs.has_pr == '1' && steps.approve.outputs.has_approve == '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1' && steps.review.outputs.already_approved != '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.ctx.outputs.pr_number }}");
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number: pr_number,
              event: "APPROVE",
              body: "PHOSPHENE: condenser approval (checks green).",
            });

  approve_dispatch:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Load PR metadata
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number((context?.payload?.inputs || {})["pr_number"]);
            if (!pr_number) throw new Error("Missing required workflow_dispatch input: pr_number");
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
            core.setOutput("pr_number", String(pr_number));
            core.setOutput("head_sha", String(pr.data.head.sha));
            core.setOutput("base_ref", String(pr.data.base.ref));
            core.setOutput("mergeable_state", String(pr.data.mergeable_state || "").toLowerCase());
            core.setOutput("is_draft", pr.data.draft ? "1" : "0");
            core.setOutput("is_open", String(pr.data.state || "").toLowerCase() === "open" ? "1" : "0");

      - name: Checkout PR head (by SHA)
        if: steps.pr.outputs.is_open == '1'
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0
          persist-credentials: true

      - name: Extract approve signal (product-marketing) from PR diff
        id: approve
        if: steps.pr.outputs.is_open == '1'
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          base="${{ steps.pr.outputs.base_ref }}"
          git fetch origin "$base:refs/remotes/origin/$base" --force
          git diff --unified=0 "origin/$base"...HEAD -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/pr_new_lines.txt || true

          approve_line="$(node -e '
            const fs=require("fs");
            const raw=fs.existsSync("/tmp/pr_new_lines.txt")?fs.readFileSync("/tmp/pr_new_lines.txt","utf8"):"";
            const lines=raw.split(/\n/).map(l=>l.trim()).filter(Boolean);
            for (const line of lines) {
              try {
                const j=JSON.parse(line);
                if (j.signal_type==="phosphene.detector.product-marketing.approve.v1") {
                  process.stdout.write(line);
                  process.exit(0);
                }
              } catch {}
            }
            process.exit(1);
          ' && true || true)"

          if [[ -z "${approve_line:-}" ]]; then
            echo "has_approve=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          work_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.work_id||""));' "$approve_line")"
          issue_number="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.issue_number||""));' "$approve_line")"
          approve_signal_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.signal_id||""));' "$approve_line")"

          echo "has_approve=1" >> "$GITHUB_OUTPUT"
          echo "work_id=$work_id" >> "$GITHUB_OUTPUT"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "approve_signal_id=$approve_signal_id" >> "$GITHUB_OUTPUT"

      - name: Check for existing condenser approval
        id: review
        if: steps.approve.outputs.has_approve == '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.pr.outputs.pr_number }}");
            const reviews = await github.rest.pulls.listReviews({ owner, repo, pull_number: pr_number, per_page: 100 });
            const already = (reviews.data || []).some(r => r.user?.login === "github-actions[bot]" && r.state === "APPROVED");
            core.setOutput("already_approved", already ? "1" : "0");

      - name: Approve PR (condenser)
        if: steps.approve.outputs.has_approve == '1' && steps.pr.outputs.mergeable_state == 'clean' && steps.pr.outputs.is_draft != '1' && steps.pr.outputs.is_open == '1' && steps.review.outputs.already_approved != '1'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = Number("${{ steps.pr.outputs.pr_number }}");
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number: pr_number,
              event: "APPROVE",
              body: "PHOSPHENE: condenser approval (checks green).",
            });

