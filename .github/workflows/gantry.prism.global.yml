name: "gantry.prism.global"

on:
  issue_comment:
    types: [created]
  workflow_dispatch: {}

permissions:
  issues: write
  contents: read

env:
  # Gantry write boundary (when/if enabled): signal bus only.
  PHOSPHENE_GANTRY_WRITE_ALLOWLIST: |
    phosphene/signals/**
    phosphene/signals/indexes/**

concurrency:
  group: instrument-prism-global-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  parse:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    outputs:
      lane: ${{ steps.parse.outputs.lane }}
      intent: ${{ steps.parse.outputs.intent }}
      issue_number: ${{ steps.parse.outputs.issue_number }}
      ok: ${{ steps.parse.outputs.ok }}
    steps:
      - name: Parse /phosphene command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const bodyRawFull = (context.payload.comment?.body || "");
            const firstLine = bodyRawFull.split(/\r?\n/, 1)[0].trim();
            const issue_number = context.payload.issue.number;

            // Only respond to explicit summons to avoid loops/noise.
            if (!firstLine.startsWith("/phosphene ")) {
              core.setOutput("ok", "0");
              return;
            }

            // Format:
            //   /phosphene beryl <intent...>
            //   /phosphene cerulean <intent...>
            const match = firstLine.match(/^\/phosphene\s+(beryl|cerulean)\s*(.*)$/i);
            if (!match) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: "PHOSPHENE: Unknown summon. Use `/phosphene beryl <intent>` or `/phosphene cerulean <intent>`.",
              });
              core.setOutput("ok", "0");
              return;
            }

            const lane = match[1].toLowerCase();
            const intent = (match[2] || "").trim() || "(no intent provided)";

            core.setOutput("ok", "1");
            core.setOutput("lane", lane);
            core.setOutput("intent", intent);
            core.setOutput("issue_number", String(issue_number));

  beryl:
    if: needs.parse.outputs.ok == '1' && needs.parse.outputs.lane == 'beryl'
    needs: [parse]
    runs-on: ubuntu-latest
    steps:
      - name: Summon apparatus (comment-only; no apparatus workflows)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number("${{ needs.parse.outputs.issue_number }}");
            const intent = String("${{ needs.parse.outputs.intent }}");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                "@codex take issue.",
                "",
                "PHOSPHENE: prism dispatch (beryl).",
                "",
                `- **Intent**: ${intent}`,
                "",
                "Constraints:",
                "- Read `phosphene/AGENTS.md`",
                "- Read `.codex/skills/phosphene/research/SKILL.md`",
                "- Use bash-only domain scripts (no hand-editing script-managed artifacts)",
                "- Emit DONE signal to `phosphene/signals/<WORK_ID>-DONE.json` when complete",
              ].join(\"\\n\"),
            });

  cerulean:
    if: needs.parse.outputs.ok == '1' && needs.parse.outputs.lane == 'cerulean'
    needs: [parse]
    runs-on: ubuntu-latest
    steps:
      - name: Summon apparatus (comment-only; no apparatus workflows)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number("${{ needs.parse.outputs.issue_number }}");
            const intent = String("${{ needs.parse.outputs.intent }}");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                "@codex take issue.",
                "",
                "PHOSPHENE: prism dispatch (cerulean).",
                "",
                `- **Intent**: ${intent}`,
                "",
                "Constraints:",
                "- Read `phosphene/AGENTS.md`",
                "- Read `.codex/skills/phosphene/product-marketing/SKILL.md`",
                "- Use bash-only domain scripts (no hand-editing script-managed artifacts)",
                "- Emit DONE signal to `phosphene/signals/<WORK_ID>-DONE.json` when complete",
              ].join(\"\\n\"),
            });

  rework:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "TODO: re-dispatch apparatus with defect context (recirculation)."

