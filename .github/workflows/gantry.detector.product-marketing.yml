name: "gantry.detector.product-marketing"

on:
  push:
    branches: ["**"]
    paths:
      - "phosphene/signals/bus.jsonl"
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "phosphene/signals/bus.jsonl"
      - "phosphene/domains/product-marketing/**"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  # Gantry write boundary (when/if enabled): signal bus only.
  PHOSPHENE_GANTRY_WRITE_ALLOWLIST: |
    phosphene/signals/**
    phosphene/signals/indexes/**
  PHOSPHENE_HUMAN_TOKEN: ${{ secrets.PHOSPHENE_HUMAN_TOKEN }}

jobs:
  validate_push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract newly added bus lines
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          before="${{ github.event.before }}"
          after="${{ github.sha }}"
          # Collect only added lines (strip leading '+', ignore diff headers).
          git diff --unified=0 "$before" "$after" -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/new_lines.txt || true
          echo "count=$(wc -l < /tmp/new_lines.txt | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Validate tamper hash on new lines
        if: steps.diff.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          fail=0
          while IFS= read -r line; do
            [[ -n "${line:-}" ]] || continue
            bash phosphene/phosphene-core/bin/signal_tamper_hash.sh validate-line "$line" >/dev/null 2>&1 || fail=1
          done < /tmp/new_lines.txt
          [[ "$fail" -eq 0 ]]

  detect_and_emit_branch:
    if: github.event_name == 'push' && github.ref_name != 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Validate bus tamper hash (entire file)
        shell: bash
        run: |
          set -euo pipefail
          bash phosphene/phosphene-core/bin/signal_bus.sh validate --bus phosphene/signals/bus.jsonl

      - name: Extract newly added bus lines (push)
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          before="${{ github.event.before }}"
          after="${{ github.sha }}"
          git diff --unified=0 "$before" "$after" -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/new_lines.txt || true
          echo "count=$(wc -l < /tmp/new_lines.txt | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Locate DONE receipt (product-marketing) in new lines
        id: done
        if: steps.diff.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const raw = fs.existsSync("/tmp/new_lines.txt") ? fs.readFileSync("/tmp/new_lines.txt","utf8") : "";
            const lines = raw.split(/\n/).map(l => l.trim()).filter(Boolean);
            for (const line of lines) {
              try {
                const j = JSON.parse(line);
                if (j.signal_type === "phosphene.done.product-marketing.receipt.v1") {
                  core.setOutput("has_done", "1");
                  core.setOutput("work_id", String(j.work_id || ""));
                  core.setOutput("issue_number", String(j.issue_number || ""));
                  core.setOutput("done_signal_id", String(j.signal_id || ""));
                  core.setOutput("lane", String(j.lane || "beryl"));
                  return;
                }
              } catch {}
            }
            core.setOutput("has_done", "0");

      - name: Validate product-marketing work units
        if: steps.done.outputs.has_done == '1'
        shell: bash
        run: |
          set -euo pipefail
          lane="${{ steps.done.outputs.lane }}"
          [[ "${lane:-beryl}" == "beryl" ]] || { echo "Lane must be beryl for product-marketing (got: $lane)"; exit 2; }
          ./phosphene/phosphene-core/bin/phosphene id validate
          bash .github/scripts/validate_persona.sh --all
          bash .github/scripts/validate_proposition.sh --all
          bash .github/scripts/product-marketing-domain-done-score.sh --min-score 0

      - name: Emit approve signal to branch bus
        if: steps.done.outputs.has_done == '1' && success()
        shell: bash
        run: |
          set -euo pipefail

          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes."
            exit 1
          fi

          bus="phosphene/signals/bus.jsonl"
          work_id="${{ steps.done.outputs.work_id }}"
          issue_number="${{ steps.done.outputs.issue_number }}"
          parent_signal_id="${{ steps.done.outputs.done_signal_id }}"
          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          output_key="detector:approve:product-marketing:issue:${issue_number}"

          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh signal-id --run-marker "$work_id" --output-key "$output_key" --parent "$parent_signal_id")"
          if grep -qF "\"signal_id\":\"${signal_id}\"" "$bus"; then
            echo "PHOSPHENE: approve already present (idempotent): $signal_id" >&2
            exit 0
          fi

          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.detector.product-marketing.approve.v1\",\"work_id\":\"${work_id}\",\"domain\":\"product-marketing\",\"issue_number\":${issue_number},\"lane\":\"beryl\",\"parents\":[\"${parent_signal_id}\"],\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus "$bus" --line "$line"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add "$bus"
          git commit -m "PHOSPHENE: detector approve product-marketing (issue ${issue_number})" || exit 0
          git push origin HEAD:"${{ github.ref_name }}"

      - name: Emit trap signal to branch bus (verification_failed)
        if: steps.done.outputs.has_done == '1' && failure()
        shell: bash
        run: |
          set -euo pipefail

          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes."
            exit 1
          fi

          bus="phosphene/signals/bus.jsonl"
          work_id="${{ steps.done.outputs.work_id }}"
          issue_number="${{ steps.done.outputs.issue_number }}"
          parent_signal_id="${{ steps.done.outputs.done_signal_id }}"
          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          output_key="detector:trap:product-marketing:issue:${issue_number}"

          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh signal-id --run-marker "$work_id" --output-key "$output_key" --parent "$parent_signal_id")"
          if grep -qF "\"signal_id\":\"${signal_id}\"" "$bus"; then
            echo "PHOSPHENE: trap already present (idempotent): $signal_id" >&2
            exit 0
          fi

          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.detector.product-marketing.trap.v1\",\"work_id\":\"${work_id}\",\"domain\":\"product-marketing\",\"issue_number\":${issue_number},\"lane\":\"beryl\",\"parents\":[\"${parent_signal_id}\"],\"reason\":\"verification_failed\",\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus "$bus" --line "$line"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add "$bus"
          git commit -m "PHOSPHENE: detector trap product-marketing (issue ${issue_number})" || exit 0
          git push origin HEAD:"${{ github.ref_name }}"

  validate_pr_and_request_condenser:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR HEAD
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          persist-credentials: true

      - name: Validate bus tamper hash (entire file)
        shell: bash
        run: |
          set -euo pipefail
          bash phosphene/phosphene-core/bin/signal_bus.sh validate --bus phosphene/signals/bus.jsonl

      - name: Detect DONE receipt in PR diff
        id: done
        shell: bash
        run: |
          set -euo pipefail
          bus="phosphene/signals/bus.jsonl"
          base="${{ github.event.pull_request.base.ref }}"
          git fetch origin "$base:refs/remotes/origin/$base" --force

          git diff --unified=0 "origin/$base"...HEAD -- "$bus" \
            | grep -E '^\+' \
            | grep -vE '^\+\+\+' \
            | sed -E 's/^\+//' \
            | grep -E '^\{' \
            > /tmp/pr_new_lines.txt || true

          # Extract the first done receipt line if present.
          done_line="$(node -e '
            const fs = require("fs");
            const lines = fs.readFileSync("/tmp/pr_new_lines.txt","utf8").split(/\\n/).filter(Boolean);
            for (const line of lines) {
              try {
                const j = JSON.parse(line);
                if (j.signal_type === "phosphene.done.product-marketing.receipt.v1") {
                  process.stdout.write(line);
                  process.exit(0);
                }
              } catch {}
            }
            process.exit(1);
          ' && true || true)"

          if [[ -z "${done_line:-}" ]]; then
            echo "has_done=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          work_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.work_id||""));' "$done_line" 2>/dev/null || true)"
          sig_id="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.signal_id||""));' "$done_line" 2>/dev/null || true)"
          issue_number="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.issue_number||""));' "$done_line" 2>/dev/null || true)"
          lane="$(node -e 'const j=JSON.parse(process.argv[1]); process.stdout.write(String(j.lane||""));' "$done_line" 2>/dev/null || true)"
          if [[ -z "${lane:-}" ]]; then lane="beryl"; fi

          echo "has_done=1" >> "$GITHUB_OUTPUT"
          echo "work_id=$work_id" >> "$GITHUB_OUTPUT"
          echo "done_signal_id=$sig_id" >> "$GITHUB_OUTPUT"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "lane=$lane" >> "$GITHUB_OUTPUT"

      - name: Validate product-marketing work units
        if: steps.done.outputs.has_done == '1'
        shell: bash
        run: |
          set -euo pipefail
          lane="${{ steps.done.outputs.lane }}"
          [[ "${lane:-beryl}" == "beryl" ]] || { echo "Lane must be beryl for product-marketing (got: $lane)"; exit 2; }
          ./phosphene/phosphene-core/bin/phosphene id validate
          bash .github/scripts/validate_persona.sh --all
          bash .github/scripts/validate_proposition.sh --all
          bash .github/scripts/product-marketing-domain-done-score.sh --min-score 0

      - name: Emit approve signal to PR bus
        if: steps.done.outputs.has_done == '1' && success()
        shell: bash
        run: |
          set -euo pipefail

          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes."
            exit 1
          fi

          bus="phosphene/signals/bus.jsonl"
          work_id="${{ steps.done.outputs.work_id }}"
          issue_number="${{ steps.done.outputs.issue_number }}"
          parent_signal_id="${{ steps.done.outputs.done_signal_id }}"
          lane="${{ steps.done.outputs.lane }}"
          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          output_key="detector:approve:product-marketing:issue:${issue_number}"

          [[ -n "${work_id:-}" ]] || { echo "Missing work_id"; exit 2; }
          [[ -n "${issue_number:-}" ]] || { echo "Missing issue_number"; exit 2; }
          [[ -n "${parent_signal_id:-}" ]] || { echo "Missing done_signal_id"; exit 2; }
          [[ "${lane:-beryl}" == "beryl" ]] || { echo "Lane must be beryl (got: $lane)"; exit 2; }

          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh signal-id --run-marker "$work_id" --output-key "$output_key" --parent "$parent_signal_id")"
          if grep -qF "\"signal_id\":\"${signal_id}\"" "$bus"; then
            echo "PHOSPHENE: approve already present (idempotent): $signal_id" >&2
            exit 0
          fi

          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.detector.product-marketing.approve.v1\",\"work_id\":\"${work_id}\",\"domain\":\"product-marketing\",\"issue_number\":${issue_number},\"lane\":\"beryl\",\"parents\":[\"${parent_signal_id}\"],\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus "$bus" --line "$line"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add "$bus"
          git commit -m "PHOSPHENE: detector approve product-marketing (issue ${issue_number})" || exit 0
          git push origin HEAD:"${{ github.head_ref }}"

      - name: Emit trap signal to PR bus (verification_failed)
        if: steps.done.outputs.has_done == '1' && failure()
        shell: bash
        run: |
          set -euo pipefail

          export PHOSPHENE_GANTRY_WRITE_ALLOWLIST=$'phosphene/signals/**\nphosphene/signals/indexes/**'
          bash phosphene/phosphene-core/bin/gantry_write_allowlist_guard.sh check

          if [[ -z "${PHOSPHENE_HUMAN_TOKEN:-}" ]]; then
            echo "PHOSPHENE: missing PHOSPHENE_HUMAN_TOKEN; refusing to push bus changes."
            exit 1
          fi

          bus="phosphene/signals/bus.jsonl"
          work_id="${{ steps.done.outputs.work_id }}"
          issue_number="${{ steps.done.outputs.issue_number }}"
          parent_signal_id="${{ steps.done.outputs.done_signal_id }}"
          lane="${{ steps.done.outputs.lane }}"
          created_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          output_key="detector:trap:product-marketing:issue:${issue_number}"

          [[ -n "${work_id:-}" ]] || { echo "Missing work_id"; exit 2; }
          [[ -n "${issue_number:-}" ]] || { echo "Missing issue_number"; exit 2; }
          [[ -n "${parent_signal_id:-}" ]] || { echo "Missing done_signal_id"; exit 2; }
          [[ "${lane:-beryl}" == "beryl" ]] || { echo "Lane must be beryl (got: $lane)"; exit 2; }

          signal_id="$(bash phosphene/phosphene-core/bin/signal_hash.sh signal-id --run-marker "$work_id" --output-key "$output_key" --parent "$parent_signal_id")"
          if grep -qF "\"signal_id\":\"${signal_id}\"" "$bus"; then
            echo "PHOSPHENE: trap already present (idempotent): $signal_id" >&2
            exit 0
          fi

          line="{\"signal_version\":1,\"signal_id\":\"${signal_id}\",\"signal_type\":\"phosphene.detector.product-marketing.trap.v1\",\"work_id\":\"${work_id}\",\"domain\":\"product-marketing\",\"issue_number\":${issue_number},\"lane\":\"beryl\",\"parents\":[\"${parent_signal_id}\"],\"reason\":\"verification_failed\",\"run_marker\":\"${work_id}\",\"output_key\":\"${output_key}\",\"created_utc\":\"${created_utc}\"}"
          bash phosphene/phosphene-core/bin/signal_bus.sh append --bus "$bus" --line "$line"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${PHOSPHENE_HUMAN_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add "$bus"
          git commit -m "PHOSPHENE: detector trap product-marketing (issue ${issue_number})" || exit 0
          git push origin HEAD:"${{ github.head_ref }}"

